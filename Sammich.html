<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clyde's Sandwich Stack</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
	
  </style>
</head>
<body>
  <canvas id="game"></canvas>

<audio id="bgMusic" loop>
  <source src="music/game_music.mp3" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>

<button id="musicToggle" style="
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  background-color: #86C232;
  color: #000;
  padding: 10px 15px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-size: 1rem;
  cursor: pointer;
">
ðŸ”‡ Music On
</button>

  <script>
    // --- Game Settings ---
    const GAME_WIDTH = 1600;
    const GAME_HEIGHT = 900;
    const PRIZE_SCORE_MIN = 3;
    const PRIZE_URL = 'https://kiwifarms.st/members/potentially-criminal.182080/';

    // NEW: Constants for Clyde's movement
    const CLYDE_BASE_SPEED = 6; // The starting speed
    const CLYDE_ACCELERATION = 0.2; // How quickly he speeds up
    const CLYDE_MAX_SPEED = 12; // The top speed

    // --- Gameplay Constants ---
    const LANDING_OFFSET_X = 20;
    const LANDING_OFFSET_Y = 228;
    const STACK_SPACING = 9;
    const CHARACTER_WIDTH = 320;
    const CHARACTER_HEIGHT = 320;
    const TOPPING_WIDTH = 100;
    const TOPPING_HEIGHT = 100;
    const SANDWICH_LAYER_HEIGHT = 20;
    const MAX_MISSES = 5;
    const NO_SPAWN_ZONE_WIDTH = 200;
    const CHARACTER_VERTICAL_OFFSET = 50;
    const SCREEN_VERTICAL_SHIFT = -60;
    const REGISTER_SCALE = 0.25;
    const REGISTER_X_OFFSET = 150;
    const REGISTER_Y_OFFSET = 40;  
    const PLAY_BUTTON_SCALE = 0.5;
    const SPAWN_INTERVAL_REDUCTION = 300;

    // --- Canvas Setup ---
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    canvas.width = GAME_WIDTH;
    canvas.height = GAME_HEIGHT;

    // --- Game State ---
    let score = 0, missed = 0, gameOver = false, level = 1, spawnInterval = 2000;
    let lastSpawnTime = 0, sandwichCompleted = false, gameStarted = false;
    let showStartScreen = true, highScore = 0, levelStartTime = 0;
    let playButton = { x: 0, y: 0, width: 0, height: 0 };
    let prizeLink = { x: 0, y: 0, width: 0, height: 0, visible: false };
    let showNextLevelScreen = false;
    const toppings = [], sandwich = [];
    const toppingTypes = ["lettuce", "cheese", "tomato", "bacon", "bread"];

    const clyde = {
      x: canvas.width / 2 - CHARACTER_WIDTH / 2,
      y: canvas.height - CHARACTER_HEIGHT - CHARACTER_VERTICAL_OFFSET,
      width: CHARACTER_WIDTH, height: CHARACTER_HEIGHT,
      baseSpeed: CLYDE_BASE_SPEED, 
      speed: CLYDE_BASE_SPEED, 
      maxSpeed: CLYDE_MAX_SPEED, 
      acceleration: CLYDE_ACCELERATION
    };

    // --- Image Loading ---
    const images = {};
    // --- Image Loading ---
	const imageSources = {
		clyde:      "img/sammich_clyde.png",
		logo:       "img/game_logo.png",
		gameOver:   "img/game_over.png",
		counter:    "img/counter.png",
		register:   "img/register.png",
		background: "img/deli.png",
		clickToPlay:"img/click_play.png",
		playAgain:  "img/play_again.png",   
		nextLevel:  "img/next_level.png",
		bacon:      "img/ham.png",
		lettuce:    "img/lettuce.png",
		tomato:     "img/tomato.png",
		cheese:     "img/cheese.png",
		bread:      "img/bread.png"
	};

    Object.keys(imageSources).forEach(key => {
        images[key] = new Image();
        images[key].src = imageSources[key];
    });

    // --- Input Handling ---
    const keys = { ArrowLeft: false, ArrowRight: false };
    document.addEventListener("keydown", (e) => { if (e.key in keys) keys[e.key] = true; });
    document.addEventListener("keyup", (e) => { if (e.key in keys) { keys[e.key] = false; clyde.speed = clyde.baseSpeed; }});

    function getMousePos(event) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (event.clientX - rect.left) * scaleX,
            y: (event.clientY - rect.top) * scaleY
        };
    }
    
    function isPosInRect(pos, rect) {
        return pos.x >= rect.x && pos.x <= rect.x + rect.width &&
               pos.y >= rect.y && pos.y <= rect.y + rect.height;
    }

    canvas.addEventListener('click', function(event) {
        if (/Mobi/i.test(navigator.userAgent)) return;
        const mousePos = getMousePos(event);

        if (showStartScreen) {
            if (isPosInRect(mousePos, playButton)) {
                gameStarted = true;
                showStartScreen = false;
                lastSpawnTime = Date.now();
            }
        } else if (gameOver) {
            if (prizeLink.visible && isPosInRect(mousePos, prizeLink)) {
                window.open(PRIZE_URL, '_blank');
            } else if (isPosInRect(mousePos, playButton)) {
                resetGame();
            }
        } else if (showNextLevelScreen) {
            if (isPosInRect(mousePos, playButton)) {
                gameStarted = true;
                showNextLevelScreen = false;
                lastSpawnTime = Date.now();
            }
        }
    });

    canvas.addEventListener('mousemove', function(event) {
        const mousePos = getMousePos(event);
        if (gameOver && prizeLink.visible && isPosInRect(mousePos, prizeLink)) {
            canvas.style.cursor = 'pointer';
        } else {
            canvas.style.cursor = 'default';
        }
    });

    // --- Game Logic Functions ---
    function resetGame() {
      score = 0; missed = 0; gameOver = false; level = 1;
      spawnInterval = 2000; toppings.length = 0; sandwich.length = 0;
      sandwichCompleted = false; gameStarted = false; showStartScreen = true;
      prizeLink.visible = false;
    }

    function spawnTopping() {
        const type = toppingTypes[Math.floor(Math.random() * toppingTypes.length)];
        toppings.push({
            x: Math.random() * (canvas.width - TOPPING_WIDTH - NO_SPAWN_ZONE_WIDTH),
            y: -TOPPING_HEIGHT, type: type, speed: 4 + Math.random() * 2
        });
    }

    // --- Drawing Functions ---
    function drawStartScreen() {
      if (images.logo && images.logo.complete) {
        const imgWidth = 500;
        const imgHeight = images.logo.height * (imgWidth / images.logo.width); 
        const x = canvas.width / 2 - imgWidth / 2;
        const y = (canvas.height / 2 - imgHeight / 2 - 50) + SCREEN_VERTICAL_SHIFT;
        ctx.drawImage(images.logo, x, y, imgWidth, imgHeight);
      }
      
      if (images.clickToPlay && images.clickToPlay.complete) {
        const btnWidth = 400 * PLAY_BUTTON_SCALE;
        const btnHeight = images.clickToPlay.height * (btnWidth / images.clickToPlay.width);
        const btnX = canvas.width / 2 - btnWidth / 2;
        const btnY = (canvas.height / 2 + 150) + SCREEN_VERTICAL_SHIFT;
        ctx.drawImage(images.clickToPlay, btnX, btnY, btnWidth, btnHeight);
        playButton = { x: btnX, y: btnY, width: btnWidth, height: btnHeight };
      }
    }

	function drawGameOverScreen() {
	  prizeLink.visible = false;

	  if (images.gameOver && images.gameOver.complete) {
		const imgWidth  = 500;
		const imgHeight = images.gameOver.height * (imgWidth / images.gameOver.width);
		const x         = canvas.width / 2 - imgWidth / 2;
		const y         = (canvas.height / 2 - imgHeight / 2 - 90) + SCREEN_VERTICAL_SHIFT;
		ctx.drawImage(images.gameOver, x, y, imgWidth, imgHeight);
	  }

	  const scoreY = (canvas.height / 2 + 150) + SCREEN_VERTICAL_SHIFT;

	  if (highScore >= PRIZE_SCORE_MIN) {
		const prizeFont = "bold 45px 'Comic Sans MS', Arial";
		ctx.font       = prizeFont;
		ctx.textAlign  = "center";
		ctx.strokeStyle = "black";
		ctx.lineWidth  = 4;
		ctx.fillStyle  = "#86C232";
		ctx.strokeText(PRIZE_URL, canvas.width / 2, scoreY);
		ctx.fillText  (PRIZE_URL, canvas.width / 2, scoreY);

		const textMetrics = ctx.measureText(PRIZE_URL);
		const textHeight  = 45;
		prizeLink = {
		  x:      canvas.width / 2 - textMetrics.width / 2,
		  y:      scoreY - textHeight,
		  width:  textMetrics.width,
		  height: textHeight,
		  visible:true
		};
	  } else {
		ctx.font        = "bold 70px 'Comic Sans MS', Arial";
		ctx.textAlign   = "center";
		ctx.strokeStyle = "black";
		ctx.lineWidth   = 5;
		ctx.fillStyle   = "white";
		ctx.strokeText(highScore, canvas.width / 2, scoreY);
		ctx.fillText  (highScore, canvas.width / 2, scoreY);
	  }

	  if (images.playAgain && images.playAgain.complete) {
		const btnWidth  = 400 * PLAY_BUTTON_SCALE;
		const btnHeight = images.playAgain.height * (btnWidth / images.playAgain.width);
		const btnX      = canvas.width / 2 - btnWidth / 2;
		const btnY      = scoreY + 70;
		ctx.drawImage(images.playAgain, btnX, btnY, btnWidth, btnHeight);
		playButton = { x: btnX, y: btnY, width: btnWidth, height: btnHeight };
	  }
	}

    
    function drawNextLevelScreen() {
        if (images.nextLevel && images.nextLevel.complete) {
            const imgWidth = 500;
            const imgHeight = images.nextLevel.height * (imgWidth / images.nextLevel.width); 
            const x = canvas.width / 2 - imgWidth / 2;
            const y = (canvas.height / 2 - imgHeight / 2) + SCREEN_VERTICAL_SHIFT;
            ctx.drawImage(images.nextLevel, x, y, imgWidth, imgHeight);
        }
        if (images.clickToPlay && images.clickToPlay.complete) {
            const btnWidth = 400 * PLAY_BUTTON_SCALE;
            const btnHeight = images.clickToPlay.height * (btnWidth / images.clickToPlay.width);
            const btnX = canvas.width / 2 - btnWidth / 2;
            const btnY = (canvas.height / 2 + 150) + SCREEN_VERTICAL_SHIFT;
            ctx.drawImage(images.clickToPlay, btnX, btnY, btnWidth, btnHeight);
            playButton = { x: btnX, y: btnY, width: btnWidth, height: btnHeight };
        }
    }

    // --- Main Game Loop ---
    function update() {
      requestAnimationFrame(update);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (images.background && images.background.complete) {
        ctx.drawImage(images.background, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = "#c2e0ff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      if (showStartScreen) { drawStartScreen(); }
      else if (showNextLevelScreen) { drawNextLevelScreen(); }
      else if (gameOver) { drawGameOverScreen(); }
      else if (gameStarted) {
        if (keys.ArrowLeft) {
          clyde.x -= clyde.speed;
          clyde.speed = Math.min(clyde.speed + clyde.acceleration, clyde.maxSpeed);
        } else if (keys.ArrowRight) {
          clyde.x += clyde.speed;
          clyde.speed = Math.min(clyde.speed + clyde.acceleration, clyde.maxSpeed);
        } else { clyde.speed = clyde.baseSpeed; }

        clyde.x = Math.max(0, Math.min(canvas.width - clyde.width, clyde.x));
        clyde.y = canvas.height - clyde.height - CHARACTER_VERTICAL_OFFSET;

        if(images.clyde && images.clyde.complete) ctx.drawImage(images.clyde, clyde.x, clyde.y, clyde.width, clyde.height);

        for (let i = toppings.length - 1; i >= 0; i--) {
          let t = toppings[i];
          t.y += t.speed;
          
          let breadX = clyde.x + LANDING_OFFSET_X;
          let breadY = clyde.y + LANDING_OFFSET_Y - (sandwich.length * STACK_SPACING);

          if (t.y + TOPPING_HEIGHT >= breadY && t.y <= breadY + SANDWICH_LAYER_HEIGHT &&
              t.x < breadX + TOPPING_WIDTH && t.x + TOPPING_WIDTH > breadX) {
            sandwich.push(t.type);
            toppings.splice(i, 1);
            if (t.type === "bread") {
              sandwichCompleted = true;
              setTimeout(() => {
                level++; score += 5;
                spawnInterval = Math.max(400, spawnInterval - SPAWN_INTERVAL_REDUCTION);
                toppings.length = 0; sandwich.length = 0; sandwichCompleted = false;
                gameStarted = false; showNextLevelScreen = true;
                lastSpawnTime = Date.now();
              }, 1000);
            } else { score++; }
          } else if (t.y > canvas.height) {
            toppings.splice(i, 1);
            missed++;
            if (missed >= MAX_MISSES) {
              gameOver = true;
              highScore = Math.max(highScore, score);
            }
          }
        }
        
        toppings.forEach(t => ctx.drawImage(images[t.type], t.x, t.y, TOPPING_WIDTH, TOPPING_HEIGHT));
        sandwich.forEach((part, i) => {
            const x = clyde.x + LANDING_OFFSET_X;
            const y = clyde.y + LANDING_OFFSET_Y - (i * STACK_SPACING);
            ctx.drawImage(images[part], x, y, TOPPING_WIDTH, SANDWICH_LAYER_HEIGHT);
        });
        
        if (!sandwichCompleted && Date.now() - lastSpawnTime > spawnInterval) {
          spawnTopping();
          lastSpawnTime = Date.now();
        }

        ctx.font = "30px 'Comic Sans MS', Arial"; ctx.textAlign = "left";
        ctx.lineWidth = 4; ctx.strokeStyle = "black"; ctx.fillStyle = "white";
        ctx.strokeText("Score: " + score, 20, 40); ctx.fillText("Score: " + score, 20, 40);
        ctx.strokeText("Missed: " + missed + " / " + MAX_MISSES, 20, 80); ctx.fillText("Missed: " + missed + " / " + MAX_MISSES, 20, 80);
        ctx.strokeText("Level: " + level, 20, 120); ctx.fillText("Level: " + level, 20, 120);
      }
      
      if (images.counter && images.counter.complete) {
          const desiredHeight = canvas.height * 0.10;
          ctx.drawImage(images.counter, 0, canvas.height - desiredHeight, canvas.width, desiredHeight);
      }
      if (images.register && images.register.complete) {
          const imgHeight = canvas.height * REGISTER_SCALE;
          const imgWidth = images.register.width * (imgHeight / images.register.height);
          const x = canvas.width - imgWidth - REGISTER_X_OFFSET;
          const y = canvas.height - imgHeight - REGISTER_Y_OFFSET;
          ctx.drawImage(images.register, x, y, imgWidth, imgHeight);
      }
    }
    
    // --- Music Toggle & Game Start ---
    document.getElementById('musicToggle').addEventListener('click', function() {
      const bgMusic = document.getElementById('bgMusic');
      if (bgMusic.paused) { bgMusic.play().catch(()=>{}); this.textContent = 'ðŸ”Š Music Off'; }
      else { bgMusic.pause(); this.textContent = 'ðŸ”‡ Music On'; }
    });
    
    window.onload = function() {
      resetGame();
      update();
    };
  </script>
</body>
</html>